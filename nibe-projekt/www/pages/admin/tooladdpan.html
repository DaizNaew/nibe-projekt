<template>
    <div class="page" data-name="tooladdpan">
        <div id="gridwrapper">
            <div class="grid">
                <div style="padding: 25px" id="item1"><!--Item 1-->
                    <div>
                        <form>
                            <div class="form-row">
                                <label for="aktivNavn" class="col">Værktøjs Navn</label>
                                <input id="aktivNavn" type="text" required="required" class="form-control form-control-sm col"/>
                            </div>
                            <div class="form-row">
                                <label for="Mærke" class="col">Mærke</label>
                                <input id="Mærke" type="text" class="form-control form-control-sm col"/>
                            </div>
                            <div class="form-row">
                                <label for="Model" class="col">Model</label>
                                <input id="Model" type="text" class="form-control form-control-sm col"/>
                            </div>
                            <div class="form-row">
                                <label for="Serienummer" class="col">Serienummer</label>
                                <input id="Serienummer" type="text" required="required" class="form-control form-control-sm col"/>
                            </div>
                            <div class="form-row">
                                <label for="AssetTag" class="col">Asset Tag</label>
                                <input id="AssetTag" type="text" required="required" class="form-control form-control-sm col"/>
                            </div>
                            <div class="form-row">
                                <label for="Antal" class="col">Antal</label>
                                <input id="Antal" type="number" class="form-control form-control-sm col" min="1" value="1" />
                            </div>
                            <div class="form-row">
                                <label for="Stand" class="col">Værktøjets stand</label>
                                <input id="Stand" type="text" required="required" class="form-control form-control-sm col"/>
                            </div>
                            <div class="form-row">
                                <label for="Kategori" class="col">Kategori</label>
                                <select id="Kategori" required="required" class="form-control form-control-sm col">

                                </select>
                            </div>
                            <div class="form-row">
                                <label for="certKrav" class="col">Certifikat krav</label>
                                <select id="certKrav" required="required" class="form-control form-control-sm col">
                                    <option value="-1">Ingen</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <label for="kortKrav" class="col">Kørekort krav</label>
                                <select id="kortKrav" required="required" class="form-control form-control-sm col">
                                    <option value="-1">Ingen</option>
                                </select>
                            </div>
                            <div class="form-row form-button-row">
                                <a><button id="insert" type="submit" @click="inserttool" class="no-ripple col btn btn-primary godbtn">Opret Værktøj</button></a>
                                <a><button id="update" type="submit" @click="updatetool" class="no-ripple col btn btn-primary godbtn" disabled>Opdater Værktøj</button></a>
                                <a><button id="reset" type="button" @click="resetfields" class="no-ripple col btn btn-primary godbtn">Nulstil felter</button></a>
                            </div>
                            <input id="editID" type="hidden"/>
                        </form>
                    </div>
                </div>
                <div style="padding: 25px"><!--Item 2-->
                    <div>
                            <div class="form-row" style="text-align: left">
                                    <label class="col">Værktøjs navn</label>
                                    <div class="input-wrapper">
                                        <input type="text" class="form-control form-control-sm col input-format" id="AddVærktøjsNavn">
                                        <span><i class="fas fa-search icon-format"></i></span>
                                    </div>
                                </div>
                        <div class="tableFixHead">
                            <table class="table fixed_header" style="width:auto; background-color: #c5d9ec33;">
                                <thead>
                                    <tr>
                                        <th scope="col" style="display: none;">#</th>
                                        <th class="label-cell" scope="col">Værktøjs navn</th>
                                        <th class="label-cell" scope="col">Kategori</th>
                                        <th class="label-cell" scope="col">Mærke</th>
                                        <th class="label-cell" scope="col">Model</th>
                                        <th class="label-cell" scope="col">Serienummer</th>
                                        <th class="label-cell" scope="col">AssetTag</th>
                                        <th class="radio-cell" scope="col">
                                            <!--<input type="checkbox" class="no-ripple"/>-->
                                            <i class="icon-radio"></i>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="tableBody">
                                    
                                </tbody>
                            </table>
                        </div>
                        <div class="form-row form-button-row">
                            <a><button type="submit" @click="edittool" class="no-ripple col btn btn-primary godbtn">Rediger Værktøj</button></a>
                            <a><button type="button" @click="deletetool" class="no-ripple col btn btn-primary godbtn deletebtn">Slet Værktøj</button></a>
                        </div>
                    </div>
                </div>
            </div>
        
        </div>
    </div>
    </template>

    <script>
        return {
            data: function () {
                return {
                    oversigtListTools: [],
                };
            },
        // Component Methods
            methods: {
                resetfields : () => {
                    app.dialog.confirm('Er du sikker på at du vil nulstille alle felter?', 'Nulstil Felter', function(){
                        let inputs = $$('form').find('input');
                        inputs.val('');
                        $$('form').find('#Antal').prop('disabled', false);
                        $$('form').find('#update').prop('disabled', true);
                        $$('form').find('#insert').prop('disabled', false);
                        $$('form').find(`#Kategori`).val(0);
                        $$('form').find(`#certKrav`).val("-1");
                        $$('form').find(`#kortKrav`).val("-1");
                    });
                },
                deletetool : () => {
                    app.dialog.confirm('Er du sikker på at du vil slette dette værktøj fra databasen?', 'Slet Værktøj', () => {
                        var checkBoxObj = $$('.tableBody').find('input[type="radio"]');
                        checkBoxObj.forEach(element => {
                            if(element.checked) {
                                app.request.getJSON(`${app.data['serverip']}functions/callsp.php?sp=sp_DeleteEC&param=${element.value}`, (response) =>{})
                                app.request.getJSON(`${app.data['serverip']}functions/callsp.php?sp=sp_DeleteEK&param=${element.value}`, (response) =>{})
                                app.request.getJSON(`${app.data['serverip']}functions/tools/delete.php?id=${element.value}`, (data) => {
                                    if(data.result == 1) {
                                        app.methods.addToLog(`${app.data['userID']}`, `Slettet værktøjet ${element.parentElement.parentElement.children[1].innerHTML} med assetTag (${element.parentElement.parentElement.children[6].innerHTML})`);
                                        app.dialog.alert('Værktøjet blev slettet fra databasen', 'Success af sletning', () => {
                                            app.views.main.router.navigate("/tooladdpan/", {reloadCurrent: true,});
                                        });
                                    } else {
                                        app.dialog.alert('Værktøjet blev IKKE slettet fra databasen', 'Fejl af sletning', () => {
                                            app.views.main.router.navigate("/tooladdpan/", {reloadCurrent: true,});
                                        });
                                    }
                                });
                            }
                        });
                    });
                },
                inserttool : async () => {

                    let certkravID = $$('#certKrav').val();
                    let kortkravID = $$('#kortKrav').val();
                    let tool = {
                        activeName: $$('#aktivNavn').val(),
                        brandName:  $$('#Mærke').val(),
                        modelName:  $$('#Model').val(),
                        serialNumber:  $$('#Serienummer').val(),
                        assetTag:  $$('#AssetTag').val(),
                        condition:  $$('#Stand').val(),
                        categoryID:  $$('#Kategori').val(),
                    };

                    if(tool.activeName == ""){
                    app.dialog.alert("Værktøj Navn feltet må ikke være tomt.", "Opret værktøj");
                    return;
                    }
                    if(tool.assetTag == ""){
                        app.dialog.alert("Asset Tag feltet må ikke være tomt.", "Opret værktøj");
                        return;
                    }
                    if(tool.condition == ""){
                        app.dialog.alert("Værktøjs stand feltet må ikke være tomt.", "Opret værktøj");
                        return;
                    }
                    if(document.getElementById('Antal') == ""){
                        app.dialog.alert("Antal feltet må ikke være tomt.", "Opret værktøj");
                        return;
                    }

                    let dat;
                    let toastMessage = '';
                    let newToolID;

                    let prom = new Promise((resolve, reject) => {
                        for(let i = 1; i <= $$('#Antal').val(); i++) {
                        app.request.post(`${app.data['serverip']}endpoint/equipment.php`, tool, (data) => {
                            app.methods.addToLog(`${app.data['userID']}`, `Oprettet værktøjet ${tool.activeName} med assetTag (${tool.assetTag})`);
                            dat = data;

                            if(certkravID != -1 || kortkravID != -1){
                                app.request.getJSON(`${app.data['serverip']}functions/callsp.php?sp=sp_GetNewestEquipmentID&param=${tool.assetTag}`, (response) =>{
                                newToolID = response.records[0].ID;
                                if(certkravID != -1){
                                    app.request.getJSON(`${app.data['serverip']}functions/callsp.php?sp=sp_InsertIntoEC&param=${newToolID},${certkravID}`, (response) =>{
                                        if(kortkravID == -1){
                                            resolve();
                                        }else{
                                            app.request.getJSON(`${app.data['serverip']}functions/callsp.php?sp=sp_InsertIntoEK&param=${newToolID},${kortkravID}`, (response) =>{
                                                resolve();
                                            })
                                        }
                                    },function(e){console.log(e)})
                                }else{
                                    if(kortkravID == -1){
                                            resolve();
                                        }else{
                                            app.request.getJSON(`${app.data['serverip']}functions/callsp.php?sp=sp_InsertIntoEK&param=${newToolID},${kortkravID}`, (response) =>{
                                                resolve();
                                            })
                                        }
                                }
                                })
                            }else{
                                resolve();
                            }
                            
                        }, (error) => {
                            console.error(error)
                            reject();
                        }, 'json');
                        
                        }
                    })

                    await prom;

                        if(dat.result == 1) {
                            toastMessage = 'Værktøjet blev sat ind i databasen';
                        } else {
                            toastMessage = 'Værktøjet blev IKKE sat ind i databasen'
                        }
                        app.dialog.alert(toastMessage, 'Opret Værktøj', () => {
                            app.views.main.router.navigate("/tooladdpan/", {reloadCurrent: true,});
                        });
                    
                },
                edittool : () => {
                    var checkBoxObj = $$('.tableBody').find('input[type="radio"]');
                    let inputFields = $$('form').find(`input[type="text"]`);
                    $$('form').find('#Antal').prop('disabled', true)
                    $$('form').find('#update').prop('disabled', false);
                    $$('form').find('#insert').prop('disabled', true);
                        checkBoxObj.forEach(element => {
                            if(element.checked) {
                                $$('form').find('#editID').val($$(element.parentElement.parentElement).find('input[type="radio"]').val());
                                let equipmentID = $$('form').find('#editID').val()

                                app.request.getJSON(`${app.data['serverip']}functions/callsp.php?sp=sp_GetSingleEquipmentCertifikat&param=${equipmentID}`, (response) => {
                                    $$('form').find(`#certKrav`).val(response.records[0].certifikatID);
                                },function(e, e2){
                                    $$('form').find(`#certKrav`).val("-1");
                                })

                                app.request.getJSON(`${app.data['serverip']}functions/callsp.php?sp=sp_GetSingleEquipmentKørekort&param=${equipmentID}`, (response) => {
                                    $$('form').find(`#kortKrav`).val(response.records[0].kørekortID);
                                },function(e, e2){
                                    $$('form').find(`#kortKrav`).val("-1");
                                })


                                let cells = $$(element.parentElement.parentElement).find('.label-cell');
                                cells.forEach(element => {
                                    input = $$(inputFields).find(`${element.classList[1]}`).val();
                                    if(element.firstChild != null){
                                        input_data = element.firstChild.data;
                                        $$('form').find(`#${element.classList[1]}`).val(input_data);
                                    }
                                    if(element.classList[1] == 'Kategori') {
                                        $$('form').find(`#${element.classList[1]}`).val(element.firstChild.parentElement.attributes[1].value);
                                    }
                                })
                                
                            }
                        });
                },
                updatetool : async () => {
                    let tool = {
                        activeName: $$('#aktivNavn').val(),
                        brandName:  $$('#Mærke').val(),
                        modelName:  $$('#Model').val(),
                        serialNumber:  $$('#Serienummer').val(),
                        assetTag:  $$('#AssetTag').val(),
                        condition:  $$('#Stand').val(),
                        categoryID:  $$('#Kategori').val(),
                        ID: $$('#editID').val(),
                    };

                    if(tool.activeName == ""){
                    app.dialog.alert("Værktøj Navn feltet må ikke være tomt.", "Opret værktøj");
                    return;
                    }
                    if(tool.assetTag == ""){
                        app.dialog.alert("Asset Tag feltet må ikke være tomt.", "Opret værktøj");
                        return;
                    }
                    if(tool.condition == ""){
                        app.dialog.alert("Værktøjs stand feltet må ikke være tomt.", "Opret værktøj");
                        return;
                    }

                    let dat;
                    let toastMessage = '';

                    let prom = new Promise((resolve, reject) => {

                        app.request.post(`${app.data['serverip']}functions/tools/update.php`, tool, (data) => {
                            app.methods.addToLog(`${app.data['userID']}`, `Ændret værktøjet ${tool.activeName} med assetTag (${tool.assetTag})`);
                            dat = data;
                            let equipmentID = $$('form').find('#editID').val();
                            let certKravID = $$('form').find(`#certKrav`).val();
                            let kortKravID = $$('form').find(`#kortKrav`).val();

                            app.request.getJSON(`${app.data['serverip']}functions/callsp.php?sp=sp_DeleteEC&param=${equipmentID}`, (response) => {});
                            app.request.getJSON(`${app.data['serverip']}functions/callsp.php?sp=sp_DeleteEK&param=${equipmentID}`, (response) => {});

                            if(certKravID != -1 || kortKravID != -1){
                                if(certKravID != -1){
                                    app.request.getJSON(`${app.data['serverip']}functions/callsp.php?sp=sp_InsertIntoEC&param=${equipmentID},${certKravID}`, (response) =>{
                                        if(kortKravID == -1){
                                            resolve();
                                        }else{
                                            app.request.getJSON(`${app.data['serverip']}functions/callsp.php?sp=sp_InsertIntoEK&param=${equipmentID},${kortKravID}`, (response) =>{
                                                resolve();
                                            })
                                        }
                                    })
                                }else{
                                    if(kortKravID == -1){
                                        resolve();
                                    }else{
                                        app.request.getJSON(`${app.data['serverip']}functions/callsp.php?sp=sp_InsertIntoEK&param=${equipmentID},${kortKravID}`, (response) =>{
                                            resolve();
                                        })
                                    }

                                }
                            }else{
                                resolve();
                            }

                            
                        }, (error) => {
                            reject();
                        }, 'json');
                        
                        
                    })

                    await prom;

                        if(dat.result == 1) {
                            toastMessage = 'Værktøjet blev opdateret i databasen';
                        } else {
                            toastMessage = 'Værktøjet blev opdateret i databasen';
                        }
                        app.dialog.alert(toastMessage, 'Opdater Værktøj', () => {
                            app.views.main.router.navigate("/tooladdpan/", {reloadCurrent: true,});
                        });
                },
                fillTableDefault: function() {
                    let innerHTML = "";
                    let total = 0;
                    var app = this.$app;
                    let p = 0;
                    let p2 = 0;

                    this.oversigtListTools.length = 0;
                    
                    // request user data on page init
                    app.request.getJSON(`${app.data['serverip']}endpoint/equipment.php?id=-1&limit=200&offset=0`, (tools) => {
                        // update component state with new state
                        for(let i = 0; i < tools.records.length; i++) {
                            total++;
                            innerHTML += 
                            `
                            <tr>
                                <td style="display: none;">${tools.records[i].ID}</td>
                                <td class="label-cell aktivNavn">${tools.records[i].activeName}</td>
                                <td class="label-cell Kategori" value="${tools.records[i].categoryID}">${tools.records[i].categoryName}</td>
                                <td class="label-cell Mærke">${tools.records[i].brandName}</td>
                                <td class="label-cell Model">${tools.records[i].modelName}</td>
                                <td class="label-cell Serienummer">${tools.records[i].serialNumber}</td>
                                <td class="label-cell AssetTag">${tools.records[i].assetTag}</td>
                                <td class="label-cell Stand" style="display:none;">${tools.records[i].condition}</td>
                                <td class="radio-cell">
                                    <input type="radio" value="${tools.records[i].ID}" name="selectedTool"/>
                                    <i class="icon-radio"></i>
                                </td>
                            </tr>
                            `;
                            $$('.tableBody').html(innerHTML);
                            if (i !== 0) {
                                if (this.oversigtListTools[p].navn != tools.records[i].activeName) {
                                    this.oversigtListTools.push({ navn: `${tools.records[i].activeName}`, ID: `${tools.records[i].ID}` });
                                    p++;
                                }
                            } else {
                                this.oversigtListTools.push({ navn: `${tools.records[i].activeName}`, ID: `${tools.records[i].ID}` });
                            }
                        }
                    });

                    app.request.getJSON(`${app.data['serverip']}endpoint/equipment.php?id=-1&limit=20000&offset=200`, (tools) => {
                        // update component state with new state
                        for(let i = 0; i < tools.records.length; i++) {
                            total++;
                            innerHTML += 
                            `
                            <tr>
                                <td style="display: none;">${tools.records[i].ID}</td>
                                <td class="label-cell aktivNavn">${tools.records[i].activeName}</td>
                                <td class="label-cell Kategori" value="${tools.records[i].categoryID}">${tools.records[i].categoryName}</td>
                                <td class="label-cell Mærke">${tools.records[i].brandName}</td>
                                <td class="label-cell Model">${tools.records[i].modelName}</td>
                                <td class="label-cell Serienummer">${tools.records[i].serialNumber}</td>
                                <td class="label-cell AssetTag">${tools.records[i].assetTag}</td>
                                <td class="label-cell Stand" style="display:none;">${tools.records[i].condition}</td>
                                <td class="radio-cell">
                                    <input type="radio" value="${tools.records[i].ID}" name="selectedTool"/>
                                    <i class="icon-radio"></i>
                                </td>
                            </tr>
                            `;
                            $$('.tableBody').html(innerHTML);
                            if (i !== 0) {
                                if (this.oversigtListTools[p2].navn != tools.records[i].activeName) {
                                    this.oversigtListTools.push({ navn: `${tools.records[i].activeName}`, ID: `${tools.records[i].ID}` });
                                    p2++;
                                }
                            } else {
                                this.oversigtListTools.push({ navn: `${tools.records[i].activeName}`, ID: `${tools.records[i].ID}` });
                            }
                        }
                    });
                    setTimeout(function(){
                        console.log("Opret værktøj: " + total)
                    }, 5000);
                },
                fillTableToolName: function(name) {
                    let innerHTML = "";
                    
                    var app = this.$app;
                    // request user data on page init
                    app.request.getJSON(`${app.data['serverip']}functions/callsp.php?sp=sp_GetSelectTool&param=${name}`, (tools) => {
                        // update component state with new state
                        for(let i = 0; i < tools.records.length; i++) {
                            innerHTML += 
                            `
                            <tr>
                                <td style="display: none;">${tools.records[i].ID}</td>
                                <td class="label-cell aktivNavn">${tools.records[i].aktivNavn}</td>
                                <td class="label-cell Kategori" value="${tools.records[i].katID}">${tools.records[i].katNavn}</td>
                                <td class="label-cell Mærke">${tools.records[i].brand}</td>
                                <td class="label-cell Model">${tools.records[i].model}</td>
                                <td class="label-cell Serienummer">${tools.records[i].serieNummer}</td>
                                <td class="label-cell AssetTag">${tools.records[i].assetTag}</td>
                                <td class="label-cell Stand" style="display:none;">${tools.records[i].stand}</td>
                                <td class="radio-cell">
                                    <input type="radio" value="${tools.records[i].ID}" name="selectedTool"/>
                                    <i class="icon-radio"></i>
                                </td>
                            </tr>
                            `;
                            $$('.tableBody').html(innerHTML);
                        }
                    });
                },
                
            },
        // Component States
            on: {
                pageMounted: function (page) {
                    var app = this.$app;
                    app.request.getJSON(`${app.data['serverip']}endpoint/category.php?id=-1`, (cats) => {
                        for(cat of cats.categories) {
                            $$('#Kategori').append(`<option value="${cat.ID}">${cat.katNavn}</option>`)
                        }
                    });

                    app.request.getJSON(`${app.data['serverip']}endpoint/certificate.php?id=-1&tableid=0`, (certs) => {
                        for(cert of certs.certifikat){
                            $$('#certKrav').append(`<option value="${cert.ID}">${cert.type}</option>`)
                        }
                    });

                    app.request.getJSON(`${app.data['serverip']}endpoint/certificate.php?id=-1&tableid=1`, (korts) => {
                        for(kort of korts.kørekort){
                            $$('#kortKrav').append(`<option value="${kort.ID}">${kort.type}</option>`)
                        }
                    });

                   this.fillTableDefault();
                    var oldrow = null;
                    $$('.tableBody').on('click', (e) => {
                        if(oldrow == null){
                            oldrow = e;
                        }else{
                            $$(oldrow.target.parentElement).css('background-color', '');
                            oldrow = e;
                        }
                            $$(e.target.parentElement).find('input[type="radio"]').prop('checked', true);
                            $$(e.target.parentElement).css('background-color', '#a8baad');
                        
                    });

                    var autocompleteToolList = app.autocomplete.create({
                        inputEl: '#AddVærktøjsNavn',
                        openIn: 'dropdown',
                        textProperty: "navn",
                        valueProperty: "navn",
                        limit: 5,
                        source: (query, render) => {
                            var results = [];
                            if (query.length === 0) {
                                render(results);
                                return;
                            }
                            // Find matched items
                            for (var i = 0; i < this.oversigtListTools.length; i++) {
                                if (this.oversigtListTools[i].navn.toLowerCase().indexOf(query.toLowerCase()) >= 0) results.push(this.oversigtListTools[i]);
                            }
                            // Render items by passing array with result items
                            render(results);

                        },
                        on: {
                            closed: (ele) => {
                                //Check hvis feltet bliver sat til empty 
                                if (this.oversigtListTools.filter(l => (l.navn === ele.$inputEl[0].value)).length == 0) { this.fillTableDefault(); }
                            },
                            change: (ele) => {
                                if (ele[0]) { this.fillTableToolName(ele[0].navn) }
                            }
                        },
                    });
                }
            },
        }
    </script>