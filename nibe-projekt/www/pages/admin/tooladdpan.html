<template>
    <div class="page" data-name="tooladdpan">
        <div id="gridwrapper">
            <div class="grid">
                <div style="padding: 10px" id="item1"><!--Item 1-->
                    <div>
                        <form>
                            <div class="form-row">
                                <label for="aktivNavn" class="col">Værktøjs Navn</label>
                                <input id="aktivNavn" type="text" required="required" class="form-control form-control-sm col"/>
                            </div>
                            <div class="form-row">
                                <label for="Mærke" class="col">Mærke</label>
                                <input id="Mærke" type="text" class="form-control form-control-sm col"/>
                            </div>
                            <div class="form-row">
                                <label for="Model" class="col">Model</label>
                                <input id="Model" type="text" class="form-control form-control-sm col"/>
                            </div>
                            <div class="form-row">
                                <label for="Serienummer" class="col">Serienummer</label>
                                <input id="Serienummer" type="text" required="required" class="form-control form-control-sm col"/>
                            </div>
                            <div class="form-row">
                                <label for="AssetTag" class="col">Asset Tag</label>
                                <input id="AssetTag" type="text" required="required" class="form-control form-control-sm col"/>
                            </div>
                            <div class="form-row">
                                <label for="Antal" class="col">Antal</label>
                                <input id="Antal" type="number" class="form-control form-control-sm col" min="1" />
                            </div>
                            <div class="form-row">
                                <label for="Stand" class="col">Værktøjets stand</label>
                                <input id="Stand" type="text" required="required" class="form-control form-control-sm col"/>
                            </div>
                            <div class="form-row">
                                <label for="Kategori" class="col">Kategori</label>
                                <select id="Kategori" required="required" class="form-control form-control-sm col">

                                </select>
                            </div>
                            <div class="form-row form-button-row">
                                <a><button type="submit" @click="inserttool" class="no-ripple col btn btn-primary godbtn">Opret Værktøj</button></a>
                                <a><button type="submit" @click="updatetool" class="no-ripple col btn btn-primary godbtn" disabled>Opdater Værktøj</button></a>
                                <a><button type="button" @click="resetfields" class="no-ripple col btn btn-primary godbtn">Nulstil felter</button></a>
                            </div>
                            <input id="editID" type="hidden"/>
                        </form>
                    </div>
                </div>
                <div style="padding: 25px"><!--Item 2-->
                    <div>
                        <div class="tableFixHead">
                            <table class="table fixed_header" style="width:auto; background-color: #9eafc033;">
                                <thead>
                                    <tr>
                                        <th scope="col">#</th>
                                        <th class="label-cell" scope="col">Værktøjs navn</th>
                                        <th class="label-cell" scope="col">Kategori</th>
                                        <th class="label-cell" scope="col">Mærke</th>
                                        <th class="label-cell" scope="col">Model</th>
                                        <th class="label-cell" scope="col">Serienummer</th>
                                        <th class="label-cell" scope="col">AssetTag</th>
                                        <th class="radio-cell" scope="col">
                                            <!--<input type="checkbox" class="no-ripple"/>-->
                                            <i class="icon-radio"></i>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="tableBody">
                                    
                                </tbody>
                            </table>
                        </div>
                        <div class="form-row form-button-row">
                            <a><button type="submit" @click="edittool" class="no-ripple col btn btn-primary godbtn">Rediger Værktøj</button></a>
                            <a><button type="button" @click="deletetool" class="no-ripple col btn btn-primary godbtn deletebtn">Slet Værktøj</button></a>
                        </div>
                    </div>
                </div>
            </div>
        
        </div>
    </div>
    </template>

    <script>
        return {
            data: function () {
                return {
                };
            },
        // Component Methods
            methods: {
                resetfields : () => {
                    app.dialog.confirm('Er du sikker på at du vil nulstille alle felter?', 'Nulstil Felter', function(){
                        let inputs = $$('form').find('input');
                        inputs.val('');
                    });
                },
                deletetool : () => {
                    app.dialog.confirm('Er du sikker på at du vil slette dette værktøj fra databasen?', 'Slet Værktøj', () => {
                        var checkBoxObj = $$('.tableBody').find('input[type="radio"]');
                        checkBoxObj.forEach(element => {
                            if(element.checked) {
                                app.request.getJSON(`http://10.11.4.136/cordova/functions/tools/delete.php?id=${element.value}`, (data) => {
                                    if(data.result == 1) {
                                        app.dialog.alert('Værktøjet blev slettet fra databasen', 'Success af sletning', () => {
                                            app.views.main.router.navigate("/tooladdpan/", {reloadCurrent: true,});
                                        });
                                    } else {
                                        app.dialog.alert('Værktøjet blev IKKE slettet fra databasen', 'Fejl af sletning', () => {
                                            app.views.main.router.navigate("/tooladdpan/", {reloadCurrent: true,});
                                        });
                                    }
                                });
                            }
                        });
                    });
                },
                inserttool : async () => {

                    let tool = {
                        activeName: $$('#aktivNavn').val(),
                        brandName:  $$('#Mærke').val(),
                        modelName:  $$('#Model').val(),
                        serialNumber:  $$('#Serienummer').val(),
                        assetTag:  $$('#AssetTag').val(),
                        condition:  $$('#Stand').val(),
                        categoryID:  $$('#Kategori').val(),
                    };

                    let dat;
                    let toastMessage = '';

                    let prom = new Promise((resolve, reject) => {
                        for(let i = 1; i <= $$('#Antal').val(); i++) {
                        app.request.post('http://10.11.4.136/cordova/endpoint/equipment.php', tool, (data) => {
                         dat = data;
                            resolve();
                        }, (error) => {
                            reject();
                        }, 'json');
                        
                        }
                    })

                    await prom;

                        if(dat.result == 1) {
                            toastMessage = 'Værktøjet blev sat ind i databasen';
                        } else {
                            toastMessage = 'Værktøjet blev IKKE sat ind i databasen'
                        }
                        app.dialog.alert(toastMessage, 'Opret Køretøj', () => {
                            app.views.main.router.navigate("/tooladdpan/", {reloadCurrent: true,});
                        });
                    
                },
                edittool : () => {
                    var checkBoxObj = $$('.tableBody').find('input[type="radio"]');
                    let inputFields = $$('form').find(`input[type="text"]`);
                    console.dir($$(inputFields));
                        checkBoxObj.forEach(element => {
                            if(element.checked) {
                                let cells = $$(element.parentElement.parentElement).find('.label-cell');
                                cells.forEach(element => {
                                    console.dir( element.classList[1] );
                                    //console.dir( $$(inputFields).find(`#${element.classList[1]}`));
                                    //console.dir( $$(inputFields).find(`input[id="Stand"]`));
                                })
                                
                            }
                        });
                },
                updatetool : () => {

                }
                
            },
        // Component States
            on: {
                pageMounted: (page) => {
                    let innerHTML = "";
                    var self = this;
                    var app = self.app;
                    app.request.getJSON('http://10.11.4.136/cordova/endpoint/category.php?id=-1', (cats) => {
                        for(cat of cats.categories) {
                            $$('#Kategori').append(`<option value="${cat.ID}">${cat.katNavn}</option>`)
                        }
                    });
                    // request user data on page init
                    app.request.getJSON('http://10.11.4.136/cordova/endpoint/equipment.php?id=-1', (tools) => {
                        // update component state with new state
                        for(let i = 0; i < tools.records.length; i++) {
                            innerHTML += 
                            `
                            <tr>
                                <td>${i+1}</td>
                                <td class="label-cell aktivNavn">${tools.records[i].activeName}</td>
                                <td class="label-cell Kategori">${tools.records[i].categoryName}</td>
                                <td class="label-cell Mærke">${tools.records[i].brandName}</td>
                                <td class="label-cell Model">${tools.records[i].modelName}</td>
                                <td class="label-cell Serienummer">${tools.records[i].serialNumber}</td>
                                <td class="label-cell AssetTag">${tools.records[i].assetTag}</td>
                                <td class="label-cell Stand" style="display:none;">${tools.records[i].condition}</td>
                                <td class="radio-cell">
                                    <input type="radio" value="${tools.records[i].ID}" name="selectedTool"/>
                                    <i class="icon-radio"></i>
                                </td>
                            </tr>
                            `;
                            $$('.tableBody').html(innerHTML);
                        }
                    });
                    $$('.tableBody').on('click', (e) => {
                        $$(e.target.parentElement).find('input[type="radio"]').prop('checked', true);
                    })
                }
            },
        }
    </script>