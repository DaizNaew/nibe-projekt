<template>
    <div class="page" data-name="certifikat">
        <div id="gridwrapper">
            <div class="grid">
                <div style="padding: 10px" id="item1"><!--Item 1-->
                    <div>
                        <form>
                            <div class="form-row">
                                <label for="aktivNavn" class="col">Navn</label>
                                <input id="aktivNavn" type="text" required="required" class="form-control form-control-sm col"/>
                                <input id="ID" type="hidden"/>
                                <input id="tableID" type="hidden"/>
                            </div>
                            <div class="form-row">
                                <label for="type" class="col">Type</label>
                                <select id="type" required="required" class="form-control form-control-sm col">
                                    <option value="Certifikat">Certifikat</option>
                                    <option value="Kørekort">Kørekort</option>
                                </select>
                            </div>
                            <div class="form-row form-button-row">
                                <a><button type="submit" @click="inserttool" class="no-ripple col btn btn-primary godbtn" id="Opretbtn">Opret kategori</button></a>
                                <a><button type="submit" @click="updatetool" class="no-ripple col btn btn-primary godbtn" id="Opdaterbtn" disabled>Opdater kategori</button></a>
                                <a><button type="button" @click="resetfields" class="no-ripple col btn btn-primary godbtn">Nulstil felter</button></a>
                            </div>
                        </form>
                    </div>
                </div>
                <div style="padding: 25px"><!--Item 2-->
                    <div>    
                        <div class="tablegrid">
                                <div class="tableFixHead">
                                    <table id="kattable" class="table" style="background-color: #c5d9ec33">
                                        <thead>
                                            <tr>
                                                <th scope="col" style="width: 32px;">#</th>
                                                <th class="label-cell" scope="col">Certifikat</th>
                                                <th class="radio-cell" scope="col">
                                                    <i class="icon-radio"></i>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody class="tableCertBody">
                                        </tbody>
                                    </table>
                                </div>

                            <div class="tableFixHead">
                                <table id="kattable" class="table" style="width:100%; min-width: 100%; max-width: 100%; background-color: #c5d9ec33">
                                    <thead>
                                        <tr>
                                            <th scope="col" style="width: 32px;">#</th>
                                            <th class="label-cell" scope="col">Kørekort</th>
                                            <th class="radio-cell" scope="col">
                                                <i class="icon-radio"></i>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="tableKortBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="form-row form-button-row">
                            <a><button type="submit" @click="edittool" class="no-ripple col btn btn-primary godbtn">Rediger certifikat/kørekort</button></a>
                            <a><button type="button" @click="deletetool" class="no-ripple col btn btn-primary godbtn deletebtn">Slet certifikat/kørekort</button></a>
                        </div>
                    </div>
                </div>
            </div>
        
        </div>
    </div>
    </template>

    <script>
        return {
        // Component Methods
            methods: {
                resetfields : () => {
                    app.dialog.confirm('Er du sikker på at du vil nulstille alle felter?', 'Nulstil felter', function(){
                        document.getElementById('aktivNavn').value = "";
                        document.getElementById("Opdaterbtn").disabled = true;
                        document.getElementById("Opretbtn").disabled = false;
                        document.getElementById("type").disabled = false; 
                    })
                },
                deletetool : () => {
                    var certCheckBoxObj = $$('.tableCertBody').find('input[type="radio"]');
                    var kortCheckBoxObj = $$('.tableKortBody').find('input[type="radio"]');
                    app.dialog.confirm('Er du sikker på at du vil slette denne certifikat/kørekort fra databasen?', 'Slet certifikat/kørekort', function(){
                    certCheckBoxObj.forEach(element => {
                        if(element.checked) {
                            app.request.getJSON(`${app.data['serverip']}functions/certs/delete.php?id=${element.value}&tableid=0`, (data) => {
                                if(data.result == 1) {
                                    let delCertNavn = element.parentElement.parentElement.children[1].innerText;
                                    app.dialog.alert(`Certifikatet (<span style='color: green; font-weight: bold;'>${delCertNavn}</span>) blev slettet fra databasen.`, "Slet certifikat", function(){
                                        app.views.main.router.navigate("/certifikat/", {reloadCurrent: true,});
                                    });
                                } else {
                                    app.dialog.alert("Certifikatet blev <span style='color: red; font-weight: bold;'>IKKE</span> slettet fra databasen.", "Slet certifikat");
                                }
                            });
                        }
                    });
                    kortCheckBoxObj.forEach(element => {
                        if(element.checked) {
                            app.request.getJSON(`${app.data['serverip']}functions/certs/delete.php?id=${element.value}&tableid=1`, (data) => {
                                if(data.result == 1) {
                                    let delKøreNavn = element.parentElement.parentElement.children[1].innerText;
                                    app.dialog.alert(`Kørekortet (<span style='color: green; font-weight: bold;'>${delKøreNavn}</span>) blev slettet fra databasen.`, "Slet kørekort", function(){
                                        app.views.main.router.navigate("/certifikat/", {reloadCurrent: true,});
                                    });
                                } else {
                                    app.dialog.alert("Kørekortet blev <span style='color: red; font-weight: bold;'>IKKE</span> slettet fra databasen.", "Slet kørekort");
                                }
                            });
                        }
                    });

                    })
                },
                inserttool : () => {
                    let newTingNavn = document.getElementById('aktivNavn').value;
                    let tableID = document.getElementById('type').selectedIndex;
                    let typenavn = document.getElementById('type').value + "et";
                    if(newTingNavn == ""){
                        app.dialog.alert("Navn feltet må ikke være tomt.", "Opret certifikat/kørekort");
                        return;
                    }
                    app.request.post(`${app.data['serverip']}endpoint/certificate.php`, { type:`${newTingNavn}`, tableID: tableID }, function(response){
                        if(response.result == 1){
                            app.dialog.alert(`${typenavn} (<span style="color: green; font-weight: bold;">${newTingNavn}</span>) blev tilføjet til databasen.`, "Opret certifikat/kørekort", function(){
                                app.views.main.router.navigate("/certifikat/", {reloadCurrent: true,});
                            });

                        }else{
                            app.dialog.alert(`${typenavn} blev <span style='color: red; font-weight: bold;'>IKKE</span> tilføjet til databasen.`, "Opret certifikat/kørekort");
                            return;
                        }
                    }, function(e, e2){
                    }, "json");
                },

                edittool : () => {
                    var certCheckBoxObj = $$('.tableCertBody').find('input[type="radio"]');
                    var kortCheckBoxObj = $$('.tableKortBody').find('input[type="radio"]');
                    certCheckBoxObj.forEach(element => {
                        if(element.checked) {
                            document.getElementById('aktivNavn').value = element.parentElement.parentElement.children[1].innerHTML;
                            document.getElementById('ID').value = element.parentElement.parentElement.children[2].children[0].value;
                            document.getElementById('tableID').value = 0;
                            document.getElementById("Opdaterbtn").disabled = false;
                            document.getElementById("Opretbtn").disabled = true; 
                            document.getElementById("type").value = "Certifikat";
                            document.getElementById("type").disabled = true; 
                        }
                    });
                    kortCheckBoxObj.forEach(element => {
                        if(element.checked) {
                            document.getElementById('aktivNavn').value = element.parentElement.parentElement.children[1].innerHTML;
                            document.getElementById('ID').value = element.parentElement.parentElement.children[2].children[0].value;
                            document.getElementById('tableID').value = 1;
                            document.getElementById("Opdaterbtn").disabled = false;
                            document.getElementById("Opretbtn").disabled = true;
                            document.getElementById("type").value = "Kørekort";
                            document.getElementById("type").disabled = true; 
                        }
                    });
                },

                updatetool : () => {
                    let updatedType = document.getElementById('aktivNavn').value;
                    let updatedID = document.getElementById('ID').value;
                    let updatedtableID = document.getElementById('tableID').value;
                    app.request.post(`${app.data['serverip']}functions/certs/update.php`, { type:`${updatedType}`, ID:`${updatedID}`, tableID:`${updatedtableID}`}, function(response){
                        app.views.main.router.navigate("/certifikat/", {reloadCurrent: true,});
                    }, function(e, e2){
                    }, "json");
                    
                },
            },
        // Component States
        on: {
                pageMounted: (page) => {
                    let innerHTMLCert = "";
                    let innerHTMLKort = "";
                    var oldrow = null;
                    var self = this;
                    var app = self.app;
                    // request user data on page init
                    app.request.getJSON(`${app.data['serverip']}endpoint/certificate.php?id=-1&tableid=0`, (response) => {
                        // update component state with new state
                        for(let i = 0; i < response.certifikat.length; i++) {
                            
                            innerHTMLCert += 
                            `
                            <tr>
                                <td style="width: 32px;">${response.certifikat[i].ID}</td>
                                <td class="label-cell">${response.certifikat[i].type}</td>
                                <td class="radio-cell">
                                    <input type="radio" value="${response.certifikat[i].ID}" name="radiogroup"/>
                                    <i class="icon-radio"></i>
                                </td>
                            </tr>
                            `;
                            $$('.tableCertBody').html(innerHTMLCert);
                        }
                    });
                    app.request.getJSON(`${app.data['serverip']}endpoint/certificate.php?id=-1&tableid=1`, (response) => {
                        // update component state with new state
                        for(let i = 0; i < response.kørekort.length; i++) {
                            
                            innerHTMLKort += 
                            `
                            <tr>
                                <td style="width: 32px;">${response.kørekort[i].ID}</td>
                                <td class="label-cell">${response.kørekort[i].type}</td>
                                <td class="radio-cell">
                                    <input type="radio" value="${response.kørekort[i].ID}" name="radiogroup"/>
                                    <i class="icon-radio"></i>
                                </td>
                            </tr>
                            `;
                            $$('.tableKortBody').html(innerHTMLKort);
                        }
                    });
                    $$('.tableCertBody').on('click', (e) => {
                        if(oldrow == null){
                            oldrow = e;
                        }else{
                            $$(oldrow.target.parentElement).css('background-color', '');
                            oldrow = e;
                        }
                            $$(e.target.parentElement).find('input[type="radio"]').prop('checked', true);
                            $$(e.target.parentElement).css('background-color', '#a8baad');
                        
                    });
                    $$('.tableKortBody').on('click', (e) => {
                        if(oldrow == null){
                            oldrow = e;
                        }else{
                            $$(oldrow.target.parentElement).css('background-color', '');
                            oldrow = e;
                        }
                            $$(e.target.parentElement).find('input[type="radio"]').prop('checked', true);
                            $$(e.target.parentElement).css('background-color', '#a8baad');
                        
                    });
                }
            },
        }
    </script>